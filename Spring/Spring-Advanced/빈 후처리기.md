# BeanPostProcessor
## 1. 목적
- 스프링이 빈 저장소에 등록할 목적으로 생성한 객체를 빈 저장소에 등록하기 직전에 조작
### 1) 너무 많은 설정
```java
@Bean  
public OrderControllerV1 orderControllerV1(LogTrace logTrace) {  
    OrderControllerV1 orderController = new OrderControllerV1Impl(orderServiceV1(logTrace));  
    ProxyFactory factory = new ProxyFactory(orderController);  
  
    factory.addAdvisor(getAdvisor(logTrace));  
    OrderControllerV1 proxy = (OrderControllerV1)factory.getProxy();  
    log.info("ProxyFactory proxy={}, target={}", proxy, orderController);  
  
    return proxy;  
}  
  
//...
```
- 프록시를 직접 스프링 빈으로 등록하려 할 경우 설정 파일에 프록시 관련 설정이 지나치게 많아진다.
### 2) 컴포넌트 스캔
- 직접 프록시를 적용할 경우 원본 객체 대신 프록시를 만들어 스프링 컨테이너에 빈으로 등록해야 하는데, 컴포넌트 스캔은 원본 객체를 자동 등록하기 때문에 직접 적용은 불가능하다.
## 2. 기능
- 객체 조작
- 완전히 다른 객체로 바꾸기
## 3. 과정
![](https://i.imgur.com/KbV0hRv.png)
![](https://i.imgur.com/ThVhyAE.png)
1. **생성** : 스프링 빈 대상이 되는 객체 생성
2. **전달** : 생성된 객체를 빈 저장소에 등록하기 직전에 빈 후처리기에 전달
3. **후 처리 작업** : 전달된 스프링 빈 객체를 조작하거나 다른 객체로 바꿔치기
4. **등록** : 빈을 반환
## 4. 인터페이스
```java
public interface BeanPostProcessor {  
    @Nullable  
    default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {  
        return bean;  
    }  
  
    @Nullable  
    default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {  
        return bean;  
    }  
}
```
- `postProcessBeforeInitialization` : 객체 생성 이후에 `@PostConstruct`같은 초기화가 발생하기 전에 호출되는 포스트 프로세서
- `postProcessAfterInitialization` : 객체 생성 이후에 `@PostConstruct` 같은 초기화가 발생한 다음에 호출되는 포스트 프로세서
## 5. 주의
### 프록시 적용 대상 여부 체크
- `basePackage`를 사용해서 특정 패키지를 기준으로 프록시 체크를 하는 것도 좋지만, PointCut을 활용하는 것이 더 좋다.
	1. 프록시 적용 대상 여부를 체크해서 꼭 필요한 곳에만 프록시를 적용한다. (빈 후처리기 - 자동 프록시 생성)
	2. 프록시의 어떤 메서드가 호출되었을 때 어드바이스를 적용할 지 판단한다. (프록시 내부)
- 스프링 부트가 기본으로 제공하는 빈 중에는 프록시 객체로 만들 수 없는 빈들도 있다.
# 스프링 제공
## library
```gradle
implementation 'org.springframework.boot:spring-boot-starter-aop'
```
- `aspectjweaver`라는 `aspectJ` 관련 라이브러리 등록
- 스프링 부트가 AOP 관련 클래스를 자동으로 스프링 빈에 등록 (스프링 부트가 없을 경우 `@EnableAspectJAutoProxy`를 직접 사용)
- `AopAutoConfiguration` : 스프링 부트가 활성화하는 빈
## AutoProxyCreator
- 자동 프록시 생성기인 `AnnotationAwareAspectJAutoProxyCreator` 빈 후처리기가 스프링 빈에 자동 등록
- 스프링 빈으로 등록된 `Advisor` 들을 자동으로 찾아 필요한 곳에 자동으로 프록시 적용
	- `Pointcut`, `Advice`가 모두 포함되어 있으므로, `Pointcut`으로 어떤 스프링 빈에 프록시를 적용해야 할지 판단하고, `Advice`로 부가 기능을 적용한다.
- `@AspectJ`도 자동으로 인식해서 프록시를 만들고 AOP를 적용한다.
## 과정
![](https://i.imgur.com/X3wbXQv.png)
1. **생성** : 스프링이 스프링 빈 대상이 되는 객체 생성 (`@Bean`, 컴포넌트 스캔 모두 포함)
2. **전달** : 생성된 객체를 빈 저장소에 등록하기 직전에 빈 후처리기에 전달
3. **모든 Advisor 빈 조회** : 자동 프록시 생성기 빈 후처리기가 스프링 컨테이너에서 모든 `Advisor`를 조회
4. **프록시 적용 대상 체크** : `Advisor`에 포함되어 있는 포인트컷을 사용해서 객체의 클래스 정보 뿐만 아니라 객체 내 모든 메서드를 포인트컷에 매칭하여 해당 객체가 프록시를 적용할 대상인지 아닌지 판단
5. **프록시 생성** : 프록시 적용 대상이면 프록시를 생성하고 반환해서 프록시를 스프링 빈으로 등록하고, 적용 대상이 아니라면 원본 객체를 빈으로 등록
6. **빈 등록**
## 여러 advisor
![](https://i.imgur.com/TmfOXRR.png)
- 여러 advisor를 모두 만족해야만 프록시가 생성됨
- 프록시는 1개만 생성