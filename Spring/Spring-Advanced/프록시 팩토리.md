## 개요
![](https://i.imgur.com/DCsAYEE.png)
- [[동적 프록시]] 통합
- 인터페이스가 있으면 JDK 동적 프록시를 사용하고, 구체 클래스만 있다면 CGLIB 사용
	- 옵션에 따라 무조건 하나의 동적 프록시로 고정 가능
## 사용
### Advice
#### 원리
![](https://i.imgur.com/cMFaNGr.png)
- JDK 동적 프록시의 `InvocationHandler`와 CGLIB가 제공하는 `MethodInterceptor`를 각각 중복으로 만들지 않아도 됨
#### 구현
##### 1) MethodInterceptor 생성
```java
package org.aopalliance.intercept;  
  
@FunctionalInterface  
public interface MethodInterceptor extends Interceptor {  
    @Nullable  
    Object invoke(@Nonnull MethodInvocation invocation) throws Throwable;  
}
```
```java
package org.aopalliance.intercept;  
  
public interface Interceptor extends Advice {  
}
```
- 스프링 AOP 모듈 (`spring-aop`)에 포함
- CGLIB의 `MethodInterceptor`와 이름이 같음
```java
@Slf4j  
public class TimeAdvice implements MethodInterceptor {  
  
    @Override  
    public Object invoke(MethodInvocation invocation) throws Throwable {  
       log.info("TimeProxy 실행");  
       long startTime = System.currentTimeMillis();  
  
       // Object result = method.invoke(target, args);  
       Object result = invocation.proceed();  
  
       long endTime = System.currentTimeMillis();  
  
       long resultTime = endTime - startTime;  
  
       log.info("TimeProxy 종료 reulstTime={}", resultTime);  
       return result;  
    }  
}
```
- `MethodInterceptor`를 구현
- `Object result = invocation.proceed()`
	- `target` 클래스를 호출하고 결과를 받는다
	- `target` 클래스 정보는 `MethodInvocation invocation` 안에 포함
##### 2) Proxy 생성 및 호출
```java
@Slf4j  
public class ProxyFactoryTest {  
  
    @Test  
    @DisplayName("인터페이스가 있으면 JDK 동적 프록시 사용")  
    void interfaceProxy() {  
       ServiceInterface target = new ServiceImpl();  
       ProxyFactory proxyFactory = new ProxyFactory(target);  
       proxyFactory.addAdvice(new TimeAdvice());  
       ServiceInterface proxy = (ServiceInterface)proxyFactory.getProxy();  
       log.info("targetClass={}", target.getClass());  
       log.info("proxyClass={}", proxy.getClass());  
  
       proxy.save(); 
    }  

	@Test  
	@DisplayName("구체 클래스만 있으면 CGLIB 사용")  
	void concreteProxy() {  
	    ConcreteService target = new ConcreteService();  
	    ProxyFactory proxyFactory = new ProxyFactory(target);  
	    proxyFactory.addAdvice(new TimeAdvice());  
	    ConcreteService proxy = (ConcreteService)proxyFactory.getProxy();  
	    log.info("targetClass={}", target.getClass());  
	    log.info("proxyClass={}", proxy.getClass());  
	  
	    proxy.call();  
	  
	    assertThat(AopUtils.isAopProxy(proxy)).isTrue();  
	    assertThat(AopUtils.isJdkDynamicProxy(proxy)).isFalse();  
	    assertThat(AopUtils.isCglibProxy(proxy)).isTrue();  
	}
}
```
- `new ProxyFactory(target)` : 생성자에 프록시의 호출 대상을 함께 넘겨 프록시 팩토리 생성
	- `target`이 인터페이스가 있다면 JDK 동적 프록시를 기본으로 사용하고, 구체 클래스만 있다면 CGLIB를 기본으로 사용
- `proxyFactory.addAdvice(new advice())` : 프록시가 사용할 부가 기능 로직 설정
##### 3) Proxy 적용 확인
```java
AopUtils.isAopProxy(proxy);  
AopUtils.isJdkDynamicProxy(proxy);  
AopUtils.isCglibProxy(proxy);
```
### proxyTargetClass
`proxyFactory.setProxyTargetClass(true);`
- 인터페이스가 있어도 강제로 CGLIB 사용

> 스프링 부트는 AOP를 적용할 때 기본적으로 `proxyTargetClass=true`로 설정
### Advisor
![](https://i.imgur.com/xb8PZEL.png)
- 특정 메서드 이름의 조건에 맞을 때만 프록시 부가 기능이 적용될 수 있도록 함
#### 사용법
##### 단일
```java
public class AdvisorTest {  
  
    @Test  
    void advisorTest1() {  
       ServiceInterface target = new ServiceImpl();  
       ProxyFactory proxyFactory = new ProxyFactory(target);  
       DefaultPointcutAdvisor advisor = new DefaultPointcutAdvisor(Pointcut.TRUE, new TimeAdvice());  
       proxyFactory.addAdvisor(advisor);  
       ServiceInterface proxy = (ServiceInterface)proxyFactory.getProxy();  
  
       proxy.save();  
       proxy.find();  
    }  
}
```
- `DefaultPointcutAdvisor` : `Advisor` 인터페이스의 가장 일반적인 구현체로 하나의 포인트컷과 하나의 어드바이스 주입
- `proxyFactory.addAdvisor(advisor)` : 프록시 팩토리 시 적용할 어드바이저를 지정하고, 필수이다.
	- `addAdvice(new advice())` 도 결과적으로 내부에서 `Pointcut.TRUE`인 어드바이저를 생성한다.
##### 다중
![](https://i.imgur.com/AGfh2Sf.png)
```java
@Test  
@DisplayName("하나의 프록시, 여러 어드바이저")  
void multiAdvisorTest2() {  
    // client -> proxy -> advisor2 -> advisor1 -> target  
    DefaultPointcutAdvisor advisor1 = new DefaultPointcutAdvisor(Pointcut.TRUE, new Advice1());  
    DefaultPointcutAdvisor advisor2 = new DefaultPointcutAdvisor(Pointcut.TRUE, new Advice2());  
  
    // 프록시1 생성  
    ServiceInterface target = new ServiceImpl();  
    ProxyFactory proxyFactory = new ProxyFactory(target);  
  
    proxyFactory.addAdvisor(advisor2);  
    proxyFactory.addAdvisor(advisor1);  
    ServiceInterface proxy = (ServiceInterface)proxyFactory.getProxy();  
  
    proxy.save();  
}
```

> 스프링의 AOP 또한 프록시를 하나만 만들고, 하나의 프록시에 여러 어드바이저를 적용한다.
> 즉, 하나의 `target`에 여러 AOP가 동시에 적용되어도, 스프링 AOP는 `target`마다 하나의 프록시만 생성한다.
### Pointcut
#### 인터페이스
```java
package org.springframework.aop;  
  
public interface Pointcut {  
    Pointcut TRUE = TruePointcut.INSTANCE;  
  
    ClassFilter getClassFilter();  
  
    MethodMatcher getMethodMatcher();  
}
```
#### 사용
```java
@Test  
@DisplayName("직접 만든 포인트컷")  
void advisorTest2() {  
    ServiceInterface target = new ServiceImpl();  
    ProxyFactory proxyFactory = new ProxyFactory(target);  
    DefaultPointcutAdvisor advisor = new DefaultPointcutAdvisor(new MyPointcut(), new TimeAdvice());  
    proxyFactory.addAdvisor(advisor);  
    ServiceInterface proxy = (ServiceInterface)proxyFactory.getProxy();  
  
    proxy.save();  
    proxy.find();  
}  
  
static class MyPointcut implements Pointcut {  
  
    @Override  
    public ClassFilter getClassFilter() {  
       return ClassFilter.TRUE;  
    }  
  
    @Override  
    public MethodMatcher getMethodMatcher() {  
       return new MyMethodMatcher();  
    }  
}
```
#### 결과
![](https://i.imgur.com/3ala80T.png)