## 1. 정의
하나의 비즈니스 작업을 여러 개의 로컬 트랜잭션으로 나누어 순차적으로 실행하고, 어떤 단계에서 실패가 발생하면 이미 완료한 단계들을 보상 트랜잭션으로 되돌려 전체적인 작업의 일관성을 보장하는 분산 트랜잭션 처리 패턴이다.

## 2. 등장 이유
소프트웨어 아키텍처에서 가장 간단한 구성은 단연 모놀리식이다.
모놀리식은 여러 구성 요소가 분리되지 않고 하나의 큰 덩어리로 합쳐진 상태를 의미한다.
즉, 모든 기능이 하나의 코드 베이스에 통합된 소프트웨어 아키텍처이다.

모놀리식 환경에서는 하나의 DB를 사용하고 로컬 메모리 안에서 트랜잭션을 관리한다.
어떠한 요청을 성공하면 commit, 실패하면 rollback이 일어나는데 단일 자원에서만 진행되므로 ACID가 보장된다.

MSA 환경에서는 서비스마다 DB가 따로 있으므로 트랜잭션이 단일 자원을 벗어나게 된다.
결국 하나의 서비스가 실패하더라도 전체 트랜잭션이 실패해야 하는데 DB가 다르므로 ACID가 보장되기 어렵다.

Reactive Streams 에서도 마찬가지다.
논블로킹이며 한 요청이 여러 시점에 분리되는데, 자원을 오래 점유할 수 없다.
트랜잭션은 DB 커넥션 단위인데 Reactive Streams 내에서는 자원은 사용 후에 즉시 반환되어야 하기에 전체를 하나로 묶어 트랜잭션을 유지할 수가 없다는 얘기가 된다.

스레드가 트랜잭션이 점유한 커넥션을 사용하고 있는 것이기 때문에 
결국 각 단계별로 로컬 트랜잭션이 발동하기에 ACID가 보장되기 어렵다.

---
그래서 2PC라는 방법이 세상에 나오게 된다.
2PC는 Two-Phase Commit의 약자로 여러 노드들 상에서 원자적 트랜잭션 커밋을 이루기 위한 프로토콜이다.
쉽게 말해 분산 트랜잭션에서 ACID를 유지하기 위한 방법이다.

![](https://i.imgur.com/Pnzd8u2.png)
2PC는 Coordinator와 Paticipant로 구성된다.
Coordinator는 트랜잭션을 관리하고 전체 프로세스를 조정하는 역할을 하고, Participant는 트랜잭션에 참여하는 각 데이터베이스나 시스템이다.

coordinator는 모든 participant에게 prepare 메시지를 보내고, 각 paticipant는 로컬 트랜잭션을 준비한다.
만약 participant 각각이 준비가 되었다면 yes 메시지를 coordinator에게 보내고, 그렇지 않다면 no 메시지를 보낸다.

coordinator는 모든 participant로부터 yes 메시지를 받으면 commit 메시지를 보내고, 하나라도 no가 있으면 abort 메시지를 보내서 트랜잭션을 rollback 한다.

개념적으로는 ACID가 지켜진다.

하지만 현실적으로 문제가 있다.
coordinator에 지나치게 의존적이기 때문에 장애가 발생하면 각 분산 시스템은 계속 락을 잡고 무한정 대기를 해야 하는 상황이 발생한다.

그래서 그 대안으로 나온 것이 Saga pattern이다.

## 3. 원리
Saga pattern은 각 서비스의 로컬 트랜잭션을 순차적으로 처리한다.
각 로컬 트랜잭션은 데이터베이스를 업데이트한 다음에 다음 로컬 트랜잭션을 트리거하는 메시지 또는 이벤트를 게시한다.
만약 롤백이 필요한 경우 보상 트랜잭션을 수행하여 각 단계의 반대 연산으로 처리한다.

### 1️⃣ Choreography-based saga
![](https://i.imgur.com/EWnz1Y4.png)
각 서비스가 이벤트에 반응해서 자기 단계만 실행하는 방식이다.

완전히 서비스가 분리되어 더욱 분산적인 구조를 가진다.
하지만 각 서비스의 연결 관계를 파악하기 어렵고 서비스 간 이벤트를 주고 받기 때문에 순환 구조를 조심해야 한다.

서비스가 많지 않은 간단한 워크플로우에 적합하다.

#### 2️⃣ Orchestration-based saga
![](https://i.imgur.com/DaKRoaD.png)
중앙 컨트롤러인 Orchestrator가 각 단계의 실행과 보상을 직접 관리한다.

중앙에서 관리하므로 흐름이 명확하다.
하지만 Orchestrator 장애 시 처리 이슈가 있다.

서비스가 복잡한 워크플로우에 적합하다.

